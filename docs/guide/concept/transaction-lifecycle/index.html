<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-guide/concept/transaction-lifecycle">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.2.0">
<title data-rh="true">Transaction Lifecycle | BNB Optimistic Rollup</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://your-docusaurus-test-site.com/opbnb-docs/docs/guide/concept/transaction-lifecycle"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Transaction Lifecycle | BNB Optimistic Rollup"><meta data-rh="true" name="description" content="This document describes the lifecycle of a transaction from creation to the committed state changes."><meta data-rh="true" property="og:description" content="This document describes the lifecycle of a transaction from creation to the committed state changes."><link data-rh="true" rel="icon" href="/opbnb-docs/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://your-docusaurus-test-site.com/opbnb-docs/docs/guide/concept/transaction-lifecycle"><link data-rh="true" rel="alternate" href="https://your-docusaurus-test-site.com/opbnb-docs/docs/guide/concept/transaction-lifecycle" hreflang="en"><link data-rh="true" rel="alternate" href="https://your-docusaurus-test-site.com/opbnb-docs/docs/guide/concept/transaction-lifecycle" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/opbnb-docs/blog/rss.xml" title="BNB Optimistic Rollup RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/opbnb-docs/blog/atom.xml" title="BNB Optimistic Rollup Atom Feed"><link rel="stylesheet" href="/opbnb-docs/assets/css/styles.cbba8081.css">
<link rel="preload" href="/opbnb-docs/assets/js/runtime~main.caf89853.js" as="script">
<link rel="preload" href="/opbnb-docs/assets/js/main.29781c01.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#docusaurus_skipToContent_fallback">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><a class="navbar__brand" href="/opbnb-docs/"><div class="navbar__logo"><img src="/opbnb-docs/img/logo.svg" alt="BNB Optimistic Rollup" class="themedImage_ToTc themedImage--light_HNdA"><img src="/opbnb-docs/img/logo.svg" alt="BNB Optimistic Rollup" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">BNB Optimistic Rollup</b></a></div><div class="navbar__items navbar__items--right"><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><main class="docMainContainer_gTbr docMainContainerEnhanced_Uz_u"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_BDYx"><div class="docItemContainer_oq1c"><article><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><div class="row"><div class="col col--12"><h1>Transaction Lifecycle</h1><p>This document describes the lifecycle of a transaction from creation to the committed state changes.
The majority of this page is copied from the <a href="https://docs.cosmos.network/main/basics/tx-lifecycle" target="_blank" rel="noopener noreferrer">Cosmos-sdk Docs</a>.
Transaction definition is described in a <a href="https://github.com/bnb-chain/greenfield-cosmos-sdk/blob/master/docs/core/transactions.md" target="_blank" rel="noopener noreferrer">different doc</a>.
The transaction will be referred to as <code>Tx</code>.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="creation">Creation<a class="hash-link" href="#creation" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="transaction-creation">Transaction Creation<a class="hash-link" href="#transaction-creation" title="Direct link to heading">​</a></h3><p>There are various ways to create transactions.
While the command-line is a straightforward method to interact with an application, transactions can also be generated through a <a href="/opbnb-docs/docs/api-sdk/grpc-rest">gRPC or REST interface</a> or another entry point specified by the application developer.
The interaction between the user and the application varies based on the web interface or wallet they use.
For example, users can create <code>Tx</code> through platforms like <a href="https://lunie.io/#/" target="_blank" rel="noopener noreferrer">Lunie.io</a> and sign them using a Ledger Nano S.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="transaction-creation-via-command-line">Transaction Creation via Command Line<a class="hash-link" href="#transaction-creation-via-command-line" title="Direct link to heading">​</a></h4><p>One of the main application interfaces is the command-line interface. The transaction <code>Tx</code> can be created by the user
inputting a command in the following format from the <a href="/opbnb-docs/docs/guide/greenfield-blockchain/cli/">command-line</a>, providing the type of transaction
in <code>[command]</code>, arguments in <code>[args]</code>, and configurations such as gas prices in <code>[flags]</code>:</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">gnfd tx </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">command</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">args</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">flags</span><span class="token punctuation" style="color:#393A34">]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>This command will automatically <strong>create</strong> the transaction, <strong>sign</strong> it using the account&#x27;s private key, and <strong>broadcast</strong>
it to the specified peer node.</p><p>There are several required and optional flags for transaction creation. The <code>--from</code> flag specifies which <a href="/opbnb-docs/docs/guide/concept/accounts">account</a>
the transaction is originating from. For example, if the transaction is sending coins, the funds will be drawn from the specified <code>from</code> address.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="gas-and-fees">Gas and Fees<a class="hash-link" href="#gas-and-fees" title="Direct link to heading">​</a></h5><p>Additionally, there are several <a href="/opbnb-docs/docs/guide/greenfield-blockchain/cli/">flags</a> users can use to indicate how much they are willing to pay in <a href="/opbnb-docs/docs/guide/concept/gas-fees">fees</a>:</p><ul><li><code>--gas</code> refers to how much <a href="/opbnb-docs/docs/guide/concept/gas-fees">gas</a>. Different from other cosmos blockchain where gas represents computational
resources, on greenfield blockchain, the gas of a transaction is predefined. It is suggested to be estimated by providing <code>auto</code>
as the value for <code>--gas</code>.</li><li><code>--gas-prices</code> specifies how much the user is willing to pay per unit of gas, which can be one or multiple denominations of tokens.
For example, <code>--gas-prices=5000000000BNB</code> means the user is willing to pay 5Gwei BNB per unit of gas.</li><li><code>--fees</code> specifies how much in fees the user is willing to pay in total.</li><li><code>--timeout-height</code> specifies a block timeout height to prevent the tx from being committed past a certain height.</li></ul><p>The ultimate value of the fees paid is equal to the gas multiplied by the gas prices. In other words, <code>fees = ceil(gas * gasPrices)</code>.
Thus, since fees can be calculated using gas prices and vice versa, the users specify only one of the two.</p><p>Later, validators decide whether to include the transaction in their block by comparing the given or calculated
<code>gas-prices</code> to their local <code>min-gas-prices</code>. <code>Tx</code> will be rejected if its <code>gas-prices</code> is not high enough, so users
are incentive to pay more.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="cli-example">CLI Example<a class="hash-link" href="#cli-example" title="Direct link to heading">​</a></h5><p>Users of the application <code>app</code> can enter the following command into their CLI to generate a transaction to send
1000wei BNB from a <code>senderAddress</code> to a <code>recipientAddress</code>. </p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">gnfd tx send </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">recipientAddress</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> 1000BNB --from </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">senderAddress</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> --gas auto</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="add-transactions-to-the-mempool">Add transactions to the Mempool<a class="hash-link" href="#add-transactions-to-the-mempool" title="Direct link to heading">​</a></h2><p>Each full-node (running Tendermint) that receives a <code>Tx</code> sends an <a href="https://docs.tendermint.com/master/spec/abci/abci.html#messages" target="_blank" rel="noopener noreferrer">ABCI message</a>,
<code>CheckTx</code>, to the application layer to check for validity, and receives an <code>abci.ResponseCheckTx</code>.
If the <code>Tx</code> passes the checks, it will be added to the Mempool of each node. The <a href="https://docs.tendermint.com/master/tendermint-core/mempool/" target="_blank" rel="noopener noreferrer"><strong>Mempool</strong></a>
is an in-memory pool of transactions that is unique to each node, and the transaction will remain pending until it is included in a block.
honest nodes will discard <code>Tx</code> if it is found to be invalid.
Prior to consensus, nodes continuously check incoming transactions and gossip them to their peers.</p><p>In this section, we will provide you with details on the functions that are used to add a transaction to the Mempool and how they work.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="types-of-checks">Types of Checks<a class="hash-link" href="#types-of-checks" title="Direct link to heading">​</a></h3><p>The full-nodes perform stateless, then stateful checks on <code>Tx</code> during the <code>CheckTx</code> ABCI function, with the goal to
identify and reject an invalid transaction as early on as possible to avoid wasted computation.</p><p><strong><em>Stateless</em></strong> checks do not require nodes to access state - light clients or offline nodes can do
them - and are thus less computationally expensive. Stateless checks include making sure addresses
are not empty, enforcing non-negative numbers, and other logic specified in the definitions.</p><p><strong><em>Stateful</em></strong> checks validated transactions and messages based on a committed state.
Some examples of the checks that a transaction goes through include verifying that the necessary values are present and
can be transacted, checking if the sender is authorized to transact or has the correct ownership,
and ensuring that the address has sufficient funds.
At any given moment, full-nodes typically have multiple versions
of the application&#x27;s internal state for different purposes. For example, nodes will execute state
changes while in the process of verifying transactions, but still need a copy of the last committed
state in order to answer queries - they should not respond using state with uncommitted changes.</p><p>In order to verify a <code>Tx</code>, full-nodes call the <code>CheckTx</code> ABCI function, which includes both <em>stateless</em> and <em>stateful</em>
checks. Further validation happens later in the <a href="#delivertx"><code>DeliverTx</code></a> stage. <code>CheckTx</code> goes
through several steps, beginning with decoding <code>Tx</code>.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="decoding-the-transactions">Decoding the transactions<a class="hash-link" href="#decoding-the-transactions" title="Direct link to heading">​</a></h3><p>When a <code>Tx</code> is received by the application from the underlying consensus engine (e.g. Tendermint), it is still in
its encoded <code>[]byte</code> form and needs to be unmarshaled in order to be processed. Then,
the <code>runTx</code> function is executed in the <code>runTxModeCheck</code> mode. This mode runs all checks but
exit before executing messages and writing state changes.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="confirm-the-transactions-messages-validatebasic">Confirm the transactions messages (ValidateBasic)<a class="hash-link" href="#confirm-the-transactions-messages-validatebasic" title="Direct link to heading">​</a></h3><p>Messages <code>sdk.Msg</code> are extracted from <code>Tx</code>. The <code>ValidateBasic</code> method of the <code>sdk.Msg</code>
interface implemented by the module developer is run for each transaction.
To discard obviously invalid messages, the <code>BaseApp</code> type calls the <code>ValidateBasic</code> method very early in the
processing of the message in the <code>CheckTx</code> and <code>DeliverTx</code> transactions.
<code>ValidateBasic</code> can include only <strong>stateless</strong> checks (checks that do not require access to the state).</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="antehandler">AnteHandler<a class="hash-link" href="#antehandler" title="Direct link to heading">​</a></h3><p>After the <code>ValidateBasic</code> method have done the checking, the <code>AnteHandler</code>s are run. The <code>AnteHandler</code> is a set of
modules that check transactions validity. Technically, they are optional, but in practice,
they are very often present to perform signature verification, gas calculation, fee deduction and other
core operations related to blockchain transactions.</p><p>A copy of the cached context is provided to the <code>AnteHandler</code>, which performs limited checks specified
for the transaction type. Using a copy allows the <code>AnteHandler</code> to do stateful checks for <code>Tx</code> without
modifying the last committed state, and revert to the original if the execution fails.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="gas-payment-process">Gas Payment Process<a class="hash-link" href="#gas-payment-process" title="Direct link to heading">​</a></h3><p>The <code>Context</code>, which keeps a <code>GasMeter</code> that will track how much gas has been used during the execution of <code>Tx</code>,
is initialized. The user-provided amount of gas for the <code>Tx</code> is known as <code>GasWanted</code>. If the <code>GasConsumed</code> parameter,
the amount of gas consumed during the execution, ever exceeds the <code>GasWanted</code> amount, the execution will stop and the changes
made to the cached copy of the state won&#x27;t be committed. Otherwise, the <code>CheckTx</code> ABCI function sets the amount of <code>GasUsed</code>
at the same value as <code>GasConsumed</code> and returns it in the result.
After calculating the gas and fee values, validator-nodes check that the user-specified
<code>gas-prices</code> is greater than their locally defined <code>min-gas-prices</code>.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="discard-or-addition-of-transactions-to-mempool">Discard or Addition of transactions to Mempool<a class="hash-link" href="#discard-or-addition-of-transactions-to-mempool" title="Direct link to heading">​</a></h3><p>If the <code>Tx</code> fails at any point during <code>CheckTx</code>, it is discarded, and the transaction lifecycle ends at that point. Otherwise, if it passes <code>CheckTx</code> successfully, the default protocol is to relay it to peer
nodes and add it to the Mempool so that the <code>Tx</code> becomes a candidate to be included in the next block.</p><p>The <strong>mempool</strong> serves the purpose of keeping track of transactions seen by all full-nodes.
Full-nodes keep a <strong>mempool cache</strong> of the last <code>mempool.cache_size</code> transactions they have seen, as a first line of
defense to prevent replay attacks. Ideally, the <code>mempool.cache_size</code> is large enough to encompass all
the transactions in the full mempool. If the mempool cache is too small to keep track of all
the transactions, <code>CheckTx</code> is responsible for identifying and rejecting replayed transactions.</p><p>Currently existing preventative measures include fees and a <code>sequence</code> (nonce) counter to distinguish
replayed transactions from identical but valid ones. If an attacker tries to spam nodes with many
copies of a <code>Tx</code>, full-nodes keeping a mempool cache will reject identical copies instead of running
the <code>CheckTx</code> function on all of them. Even if the copies have incremented <code>sequence</code> numbers, attackers are
disincentivized by the need to pay fees.</p><p>Validator nodes keep a mempool to prevent replay attacks, just as full-nodes do, but also use it as
a pool of unconfirmed transactions in preparation of block inclusion. Note that even if a <code>Tx</code>
passes all checks at this stage, it is still possible to be found invalid later on, because
<code>CheckTx</code> does not fully validate the transaction (i.e. it does not actually execute the messages).</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="inclusion-in-a-block">Inclusion in a Block<a class="hash-link" href="#inclusion-in-a-block" title="Direct link to heading">​</a></h2><p>Consensus occurs in <strong>rounds</strong>, during which validator nodes agree on which transactions to accept.
Each round begins with a proposer creating a block of the most
recent transactions and ends with <a href="/opbnb-docs/docs/guide/introduction/ecosystem#validators"><strong>validators</strong></a>,
special full-nodes with voting power responsible
for consensus, agreeing to accept the block or go with a <code>nil</code> block instead. Validator nodes
execute the consensus algorithm, the <a href="https://docs.tendermint.com/master/spec/consensus/consensus.html#terms" target="_blank" rel="noopener noreferrer">Tendermint BFT</a>,
confirming the transactions using ABCI requests to the application, in order to come to this agreement.</p><p>The first step of consensus is the <strong>block proposal</strong>. One proposer amongst the validators is chosen
by the consensus algorithm to create and propose a block - in order for a <code>Tx</code> to be included, it
must be in this proposer&#x27;s mempool.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="state-changes">State Changes<a class="hash-link" href="#state-changes" title="Direct link to heading">​</a></h2><p>The next step of the consensus is to execute the transactions to fully validate them. All full-nodes
that receive a block proposal from the correct proposer execute the transactions by calling the ABCI functions
<code>BeginBlock</code>, <code>DeliverTx</code> for each transaction,
and <code>EndBlock</code>. While each full-node runs everything
locally, this process yields a single, unambiguous result, since the messages&#x27; state transitions are deterministic and transactions are
explicitly ordered in the block proposal.</p><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">        -----------------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        |Receive Block Proposal|</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        -----------------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                  |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              v</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        -----------------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        | BeginBlock          |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        -----------------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                  |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              v</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        -----------------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        | DeliverTx(tx0)      |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        | DeliverTx(tx1)      |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        | DeliverTx(tx2)      |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        | DeliverTx(tx3)      |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        |   .         |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        |   .         |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        |   .         |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        -----------------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                  |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              v</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        -----------------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        | EndBlock        |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        -----------------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                  |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              v</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        -----------------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        | Consensus       |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        -----------------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                  |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              v</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        -----------------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        | Commit          |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        -----------------------</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="delivertx-abci-function">DeliverTx ABCI function<a class="hash-link" href="#delivertx-abci-function" title="Direct link to heading">​</a></h3><p>The <code>DeliverTx</code> ABCI function, defined in the <code>BaseApp</code> type, does the bulk of the
state transitions: the function is executed for each transaction in the block in sequential order as committed
to during consensus. Under the hood, <code>DeliverTx</code> is almost identical to the <code>CheckTx</code> function but calls the
<code>runTx</code> function in the deliver mode instead of using the check mode.
Instead of using their <code>checkState</code>, full-nodes use <code>deliverState</code>:</p><ul><li><p><strong>Decoding:</strong> Since <code>DeliverTx</code> is an ABCI call, the <code>Tx</code> is received in the encoded <code>[]byte</code> form.
First, the nodes unmarshal the transaction using the <code>TxConfig</code> defined in the app.
Then, they call <code>runTx</code> in <code>runTxModeDeliver</code>, which is similar to <code>CheckTx</code>
but also executes and writes state changes.</p></li><li><p><strong>Checks and AnteHandler:</strong> Full-nodes call the <code>validateBasicMsgs</code> and the <code>AnteHandler</code> again. This second check
happens because they may not have seen the same transactions during the addition to Mempool stage
and a malicious proposer may have included invalid ones. One difference here is that the
<code>AnteHandler</code> will not compare the <code>gas-prices</code> variable to the node&#x27;s <code>min-gas-prices</code> variable since that value is local
to each node - differing values across nodes would yield nondeterministic results.</p></li><li><p><strong><code>MsgServiceRouter</code>:</strong> While <code>CheckTx</code> would have exited, <code>DeliverTx</code> continues to run
the <code>runMsgs</code> function to fully execute each <code>Msg</code> service method within the transaction.
Since the transaction may have messages from different modules, the <code>BaseApp</code> type needs to know which module
to find the appropriate handler. This is achieved using the <code>BaseApp</code>&#x27;s <code>MsgServiceRouter</code> router so that it can be processed by
the module&#x27;s Protobuf <code>Msg</code> service.</p></li><li><p><strong><code>Msg</code> service:</strong> Protobuf <code>Msg</code> service is responsible for executing each message in the <code>Tx</code> and causes
state transitions to persist in <code>deliverTxState</code>.</p></li><li><p><strong>PostHandlers:</strong> <code>PostHandler</code>s run after the execution of the message. If they fail, the state change of <code>runMsgs</code>,
as well of <code>PostHandlers</code> are both reverted.</p></li><li><p><strong>Gas:</strong> While a <code>Tx</code> is being delivered, a <code>GasMeter</code> is used to keep track of how much
gas is being used; if execution completes, <code>GasUsed</code> is set and returned to the
<code>abci.ResponseDeliverTx</code>. If execution halts because <code>BlockGasMeter</code> or <code>GasMeter</code> has run out or something else goes
wrong, a deferred function at the end appropriately errors or panics.</p></li></ul><p>If there are any failed state changes resulting from a <code>Tx</code> being invalid or <code>GasMeter</code> running out,
the transaction processing terminates and any state changes are reverted. Invalid transactions in a
block proposal cause validator nodes to reject the block and vote for a <code>nil</code> block instead.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="commit-the-block">Commit the Block<a class="hash-link" href="#commit-the-block" title="Direct link to heading">​</a></h3><p>The final step is for the nodes to commit the block and state changes. Validator nodes
perform the previous step of executing state transitions in order to validate the transactions,
then sign the block to confirm it. Full nodes that are not validators do not
participate in consensus - i.e. they cannot vote - but listen for votes to understand whether they should commit the state changes.</p><p>When they receive enough validator votes (2/3+ <em>precommits</em> weighted by voting power), full nodes commit to a new block to be added to the blockchain and
finalize the state transitions in the application layer. A new state root is generated to serve as
a merkle proof for the state transitions. Applications use the <code>Commit</code>
ABCI method inherited from <code>Baseapp</code>; it syncs all the state transitions by
writing the <code>deliverState</code> into the application&#x27;s internal state. As soon as the state changes are
committed, <code>checkState</code> start afresh from the most recently committed state and <code>deliverState</code>
resets to <code>nil</code> in order to be consistent and reflect the changes.</p><p><strong>Notes</strong>: </p><ul><li>Not all blocks have the same number of transactions, and it is possible for consensus to
result in a <code>nil</code> block or one with none at all. </li><li>In a public blockchain network, it is possible
for validators to be <strong>byzantine</strong>, or malicious, which may prevent a <code>Tx</code> from being committed in
the blockchain. Possible malicious behaviors include the proposer deciding to censor a <code>Tx</code> by
excluding it from the block or a validator voting against the block.</li></ul><p>At this point, the transaction lifecycle of a <code>Tx</code> is over: nodes have verified its validity,
delivered it by executing its state changes, and committed those changes. The <code>Tx</code> itself,
in <code>[]byte</code> form, is stored in a block and appended to the blockchain.</p></div></div></div><div class="col col--12"><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/bnb-chain/opbnb-docs/docs/guide/concept/transaction-lifecycle.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_vwxv"></div></div></footer></div></article><div class="col col--12"><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"></nav></div></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#creation" class="table-of-contents__link toc-highlight">Creation</a><ul><li><a href="#transaction-creation" class="table-of-contents__link toc-highlight">Transaction Creation</a></li></ul></li><li><a href="#add-transactions-to-the-mempool" class="table-of-contents__link toc-highlight">Add transactions to the Mempool</a><ul><li><a href="#types-of-checks" class="table-of-contents__link toc-highlight">Types of Checks</a></li><li><a href="#decoding-the-transactions" class="table-of-contents__link toc-highlight">Decoding the transactions</a></li><li><a href="#confirm-the-transactions-messages-validatebasic" class="table-of-contents__link toc-highlight">Confirm the transactions messages (ValidateBasic)</a></li><li><a href="#antehandler" class="table-of-contents__link toc-highlight">AnteHandler</a></li><li><a href="#gas-payment-process" class="table-of-contents__link toc-highlight">Gas Payment Process</a></li><li><a href="#discard-or-addition-of-transactions-to-mempool" class="table-of-contents__link toc-highlight">Discard or Addition of transactions to Mempool</a></li></ul></li><li><a href="#inclusion-in-a-block" class="table-of-contents__link toc-highlight">Inclusion in a Block</a></li><li><a href="#state-changes" class="table-of-contents__link toc-highlight">State Changes</a><ul><li><a href="#delivertx-abci-function" class="table-of-contents__link toc-highlight">DeliverTx ABCI function</a></li><li><a href="#commit-the-block" class="table-of-contents__link toc-highlight">Commit the Block</a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer"><div class="container container-fluid"></div></footer></div>
<script src="/opbnb-docs/assets/js/runtime~main.caf89853.js"></script>
<script src="/opbnb-docs/assets/js/main.29781c01.js"></script>
</body>
</html>